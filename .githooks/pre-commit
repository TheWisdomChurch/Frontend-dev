#!/bin/sh

echo ""
echo "üîç Running pre-commit checks..."
echo ""

ERRORS=0

# ------------------------------------------------------------
# 1. TYPE SCRIPT CHECK (Skip if there are no TypeScript files)
# ------------------------------------------------------------
echo "‚ñ∏ TypeScript check..."

# Get staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')

if [ -z "$STAGED_TS_FILES" ]; then
    echo "   ‚úì No TypeScript files to check"
else
    if npx tsc --noEmit --skipLibCheck 2>/dev/null; then
        echo "   ‚úì TypeScript OK"
    else
        echo "   ‚úó TypeScript errors found"
        echo "   ‚Ñπ Run: npx tsc --noEmit --skipLibCheck"
        ERRORS=1
    fi
fi

echo ""

# ------------------------------------------------------------
# 2. PRETTIER CHECK (Optional - Comment out if not needed)
# ------------------------------------------------------------
# echo "‚ñ∏ Code formatting..."
# 
# STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|css|md|json)$')
# 
# if [ -n "$STAGED_FORMAT_FILES" ]; then
#     if npx prettier --check $STAGED_FORMAT_FILES --loglevel error 2>/dev/null; then
#         echo "   ‚úì Formatting OK"
#     else
#         echo "   ‚ö† Formatting issues (not blocking)"
#         echo "   ‚Ñπ Run: npx prettier --write $STAGED_FORMAT_FILES"
#     fi
# else
#     echo "   ‚úì No files to format"
# fi
# 
# echo ""

# ------------------------------------------------------------
# FINAL DECISION
# ------------------------------------------------------------
if [ $ERRORS -eq 0 ]; then
    echo "‚úÖ All checks passed! Ready to commit."
    echo ""
    exit 0
else
    echo "‚ùå Commit blocked due to TypeScript errors."
    echo ""
    echo "Quick fixes:"
    echo "  1. Fix TypeScript: npx tsc --noEmit --skipLibCheck"
    echo "  2. Bypass (emergency): git commit --no-verify -m \"Your message\""
    echo ""
    exit 1
fi