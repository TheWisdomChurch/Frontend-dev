#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_GIT_HOOKS:-0}" == "1" ]]; then
  echo "[pre-commit] SKIP_GIT_HOOKS=1, skipping checks."
  exit 0
fi

echo ""
echo "[pre-commit] Running staged-file quality gates..."

STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR || true)"
if [[ -z "${STAGED_FILES}" ]]; then
  echo "[pre-commit] No staged files. Skipping."
  exit 0
fi

echo "[pre-commit] Checking for merge conflict markers..."
FOUND_CONFLICT_MARKER=0
while IFS= read -r -d '' file; do
  if [[ ! -f "$file" ]]; then
    continue
  fi

  case "$file" in
    *.ts|*.tsx|*.js|*.jsx|*.json|*.md|*.mdx|*.css|*.scss|*.html|*.yml|*.yaml)
      if rg -n "^(<<<<<<< .*$|=======$|>>>>>>> .*$)" -- "$file" >/dev/null 2>&1; then
        echo "[pre-commit] Conflict marker found in $file"
        FOUND_CONFLICT_MARKER=1
      fi
      ;;
  esac
done < <(git diff --cached --name-only --diff-filter=ACMR -z)

if [[ "${FOUND_CONFLICT_MARKER}" == "1" ]]; then
  echo "[pre-commit] Resolve conflicts before committing."
  exit 1
fi
echo "[pre-commit] Conflict marker check passed."

echo "[pre-commit] Running lint-staged (Prettier + ESLint on staged files)..."
node ./node_modules/lint-staged/bin/lint-staged.js
echo "[pre-commit] lint-staged passed."

if git diff --cached --name-only --diff-filter=ACMR | rg -q '\.(ts|tsx)$'; then
  echo "[pre-commit] Running TypeScript check..."
  node ./node_modules/typescript/bin/tsc --noEmit --skipLibCheck
  echo "[pre-commit] TypeScript check passed."
else
  echo "[pre-commit] No staged TypeScript files. Skipping type-check."
fi

echo "[pre-commit] All checks passed."
