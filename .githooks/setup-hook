#!/bin/bash

echo "ğŸ”§ Setting up Git hooks for WisdomHouse project..."
echo "=================================================="

# Create githooks directory if it doesn't exist
mkdir -p .githooks

# Download/copy the pre-commit hook if it doesn't exist
if [ ! -f .githooks/pre-commit ]; then
    echo "âš   Warning: .githooks/pre-commit not found"
    echo "   Creating a basic pre-commit hook..."
    
    cat > .githooks/pre-commit << 'EOF'
#!/bin/sh
echo "ğŸš€ Running pre-commit checks..."
echo "Run: npm run hooks:setup to install the full pre-commit hook"
exit 0
EOF
    
    chmod +x .githooks/pre-commit
fi

# Make all hooks executable
chmod +x .githooks/* 2>/dev/null
echo "âœ“ Made all hooks executable"

# Configure Git to use our hooks directory
git config core.hooksPath .githooks

# Verify configuration
HOOKS_PATH=$(git config core.hooksPath)
if [ "$HOOKS_PATH" = ".githooks" ]; then
    echo "âœ“ Git hooks configured successfully: $HOOKS_PATH"
else
    echo "âŒ Failed to configure Git hooks. Current path: $HOOKS_PATH"
    echo "   Trying alternative configuration..."
    git config --local core.hooksPath .githooks
    echo "âœ“ Git hooks configured locally"
fi

# Create the actual pre-commit hook file with full checks
echo ""
echo "ğŸ“ Creating comprehensive pre-commit hook..."
cat > .githooks/pre-commit << 'EOF'
#!/bin/sh

echo "ğŸš€ Starting Pre-Commit Code Quality Check"
echo "=========================================="
echo ""

# Colors for better visibility
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_section() {
    echo ""
    echo "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo "${BLUE}  $1${NC}"
    echo "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

print_success() {
    echo "${GREEN}âœ“ $1${NC}"
}

print_error() {
    echo "${RED}âœ— $1${NC}"
}

print_warning() {
    echo "${YELLOW}âš   $1${NC}"
}

# Track if any checks failed
has_errors=false

# ------------------------------------------------------------
# 1. TYPE SCRIPT CHECK
# ------------------------------------------------------------
print_section "TypeScript Type Checking"

if npx tsc --noEmit 2>&1; then
    print_success "TypeScript type checking passed"
else
    has_errors=true
    print_error "TypeScript errors found!"
    echo ""
    echo "${YELLOW}To fix TypeScript errors, run:${NC}"
    echo "  npm run type-check"
fi

# ------------------------------------------------------------
# 2. ESLINT CHECK
# ------------------------------------------------------------
print_section "ESLint Code Quality Check"

if npm run lint 2>&1; then
    print_success "ESLint passed"
else
    has_errors=true
    print_error "ESLint errors found!"
    echo ""
    echo "${YELLOW}To fix ESLint errors, run:${NC}"
    echo "  npm run lint:fix"
fi

# ------------------------------------------------------------
# 3. PRETTIER FORMATTING CHECK
# ------------------------------------------------------------
print_section "Code Formatting Check"

if npm run prettier 2>&1; then
    print_success "Code formatting is consistent"
else
    print_warning "Code formatting issues found"
    echo ""
    echo "${YELLOW}Auto-fixing formatting...${NC}"
    
    # Fix formatting
    npm run prettier:fix 2>/dev/null
    
    # Check if files were changed
    CHANGED_FILES=$(git diff --name-only)
    if [ -n "$CHANGED_FILES" ]; then
        echo ""
        echo "${YELLOW}Formatted files (will be auto-staged):${NC}"
        echo "$CHANGED_FILES" | sed 's/^/  â€¢ /'
        
        # Stage the formatted files
        echo "$CHANGED_FILES" | xargs git add
        print_success "Formatted files have been staged"
    else
        print_success "No formatting changes needed"
    fi
fi

# ------------------------------------------------------------
# 4. BUILD CHECK
# ------------------------------------------------------------
print_section "Build Check"

if npm run build 2>&1; then
    print_success "Build successful"
else
    has_errors=true
    print_error "Build failed!"
    echo ""
    echo "${YELLOW}Fix build errors before committing${NC}"
fi

# ------------------------------------------------------------
# FINAL SUMMARY
# ------------------------------------------------------------
print_section "Check Summary"
echo ""

if [ "$has_errors" = true ]; then
    print_error "Pre-commit checks FAILED!"
    echo ""
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}  COMMIT BLOCKED: Please fix the errors above before committing${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "${YELLOW}Quick fixes:${NC}"
    echo "  1. TypeScript errors: npm run type-check"
    echo "  2. ESLint errors: npm run lint:fix"
    echo "  3. Build errors: npm run build"
    echo ""
    exit 1
else
    print_success "All checks PASSED!"
    echo ""
    echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${GREEN}  âœ“ Code is ready to commit!${NC}"
    echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 0
fi
EOF

chmod +x .githooks/pre-commit
echo "âœ“ Created comprehensive pre-commit hook"

echo ""
echo "ğŸ‰ Git hooks setup complete!"
echo ""
echo "The following checks will run on every commit:"
echo "  â€¢ TypeScript type checking"
echo "  â€¢ ESLint code quality"
echo "  â€¢ Prettier formatting (auto-fix)"
echo "  â€¢ Build verification"
echo ""
echo "To bypass hooks for a single commit:"
echo "  git commit -m \"message\" --no-verify"
echo ""
echo "To test the hooks:"
echo "  npm run hooks:test"
echo ""
echo "If hooks don't work, run:"
echo "  git config core.hooksPath .githooks"